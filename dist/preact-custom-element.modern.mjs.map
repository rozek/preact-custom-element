{"version":3,"file":"preact-custom-element.modern.mjs","sources":["../src/index.js"],"sourcesContent":["import { h, cloneElement, render, hydrate } from 'preact';\n\n/**\n * @typedef {import('preact').FunctionComponent<any> | import('preact').ComponentClass<any> | import('preact').FunctionalComponent<any> } ComponentDefinition\n * @typedef {{ shadow: false } | { shadow: true, mode: 'open' | 'closed'}} Options\n * @typedef {HTMLElement & { _root: ShadowRoot | HTMLElement, _vdomComponent: ComponentDefinition, _vdom: ReturnType<typeof import(\"preact\").h> | null }} PreactCustomElement\n */\n\n/**\n * Register a preact component as web-component.\n * @param {ComponentDefinition} Component The preact component to register\n * @param {string} [tagName] The HTML element tag-name (must contain a hyphen and be lowercase)\n * @param {string[]} [propNames] HTML element attributes to observe\n * @param {Options} [options] Additional element options\n * @example\n * ```ts\n * // use custom web-component class\n * class PreactWebComponent extends Component {\n *   static tagName = 'my-web-component';\n *   render() {\n *     return <p>Hello world!</p>\n *   }\n * }\n *\n * register(PreactComponent);\n *\n * // use a preact component\n * function PreactComponent({ prop }) {\n *   return <p>Hello {prop}!</p>\n * }\n *\n * register(PreactComponent, 'my-component');\n * register(PreactComponent, 'my-component', ['prop']);\n * register(PreactComponent, 'my-component', ['prop'], {\n *   shadow: true,\n *   mode: 'closed'\n * });\n * ```\n */\nexport default function register(Component, tagName, propNames, options) {\n\tfunction PreactElement() {\n\t\tconst inst = /** @type {PreactCustomElement} */ (\n\t\t\tReflect.construct(HTMLElement, [], PreactElement)\n\t\t);\n\t\tinst._vdomComponent = Component;\n\t\tinst._root =\n\t\t\toptions && options.shadow\n\t\t\t\t? inst.attachShadow({ mode: options.mode || 'open' })\n\t\t\t\t: inst;\n\t\treturn inst;\n\t}\n\tPreactElement.prototype = Object.create(HTMLElement.prototype);\n\tPreactElement.prototype.constructor = PreactElement;\n\tPreactElement.prototype.connectedCallback = connectedCallback;\n\tPreactElement.prototype.attributeChangedCallback = attributeChangedCallback;\n\tPreactElement.prototype.disconnectedCallback = disconnectedCallback;\n\n\t/**\n\t * @type {string[]}\n\t */\n\tpropNames =\n\t\tpropNames ||\n\t\tComponent.observedAttributes ||\n\t\tObject.keys(Component.propTypes || {});\n\tPreactElement.observedAttributes = propNames;\n\n\t// Keep DOM properties and Preact props in sync\n\tpropNames.forEach((name) => {\n\t\tObject.defineProperty(PreactElement.prototype, name, {\n\t\t\tget() {\n\t\t\t\treturn this._vdom.props[name];\n\t\t\t},\n\t\t\tset(v) {\n\t\t\t\tif (this._vdom) {\n\t\t\t\t\tthis.attributeChangedCallback(name, null, v);\n\t\t\t\t} else {\n\t\t\t\t\tif (!this._props) this._props = {};\n\t\t\t\t\tthis._props[name] = v;\n\t\t\t\t\tthis.connectedCallback();\n\t\t\t\t}\n\n\t\t\t\t// Reflect property changes to attributes if the value is a primitive\n\t\t\t\tconst type = typeof v;\n\t\t\t\tif (\n\t\t\t\t\tv == null ||\n\t\t\t\t\ttype === 'string' ||\n\t\t\t\t\ttype === 'boolean' ||\n\t\t\t\t\ttype === 'number'\n\t\t\t\t) {\n\t\t\t\t\tthis.setAttribute(name, v);\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\t});\n\n\treturn customElements.define(\n\t\ttagName || Component.tagName || Component.displayName || Component.name,\n\t\tPreactElement\n\t);\n}\n\nfunction ContextProvider(props) {\n\tthis.getChildContext = () => props.context;\n\t// eslint-disable-next-line no-unused-vars\n\tconst { context, children, ...rest } = props;\n\treturn cloneElement(children, rest);\n}\n\n/**\n * @this {PreactCustomElement}\n */\nfunction connectedCallback() {\n\t// Obtain a reference to the previous context by pinging the nearest\n\t// higher up node that was rendered with Preact. If one Preact component\n\t// higher up receives our ping, it will set the `detail` property of\n\t// our custom event. This works because events are dispatched\n\t// synchronously.\n\tconst event = new CustomEvent('_preact', {\n\t\tdetail: {},\n\t\tbubbles: true,\n\t\tcancelable: true,\n\t});\n\tthis.dispatchEvent(event);\n\tconst context = event.detail.context;\n\n\tthis._vdom = h(\n\t\tContextProvider,\n\t\t{ ...this._props, context },\n\t\ttoVdom(this, this._vdomComponent)\n\t);\n\t(this.hasAttribute('hydrate') ? hydrate : render)(this._vdom, this._root);\n}\n\n/**\n * Camel-cases a string\n * @param {string} str The string to transform to camelCase\n * @returns camel case version of the string\n */\nfunction toCamelCase(str) {\n\treturn str.replace(/-(\\w)/g, (_, c) => (c ? c.toUpperCase() : ''));\n}\n\n/**\n * Changed whenver an attribute of the HTML element changed\n * @this {PreactCustomElement}\n * @param {string} name The attribute name\n * @param {unknown} oldValue The old value or undefined\n * @param {unknown} newValue The new value\n */\nfunction attributeChangedCallback(name, oldValue, newValue) {\n\tif (!this._vdom) return;\n\t// Attributes use `null` as an empty value whereas `undefined` is more\n\t// common in pure JS components, especially with default parameters.\n\t// When calling `node.removeAttribute()` we'll receive `null` as the new\n\t// value. See issue #50.\n\tnewValue = newValue == null ? undefined : newValue;\n\tconst props = {};\n\tprops[name] = newValue;\n\tprops[toCamelCase(name)] = newValue;\n\tthis._vdom = cloneElement(this._vdom, props);\n\trender(this._vdom, this._root);\n}\n\n/**\n * @this {PreactCustomElement}\n */\nfunction disconnectedCallback() {\n\trender((this._vdom = null), this._root);\n}\n\n/**\n * Pass an event listener to each `<slot>` that \"forwards\" the current\n * context value to the rendered child. The child will trigger a custom\n * event, where will add the context value to. Because events work\n * synchronously, the child can immediately pull of the value right\n * after having fired the event.\n */\nfunction Slot(props, context) {\n\tconst ref = (r) => {\n\t\tif (!r) {\n\t\t\tthis.ref.removeEventListener('_preact', this._listener);\n\t\t} else {\n\t\t\tthis.ref = r;\n\t\t\tif (!this._listener) {\n\t\t\t\tthis._listener = (event) => {\n\t\t\t\t\tevent.stopPropagation();\n\t\t\t\t\tevent.detail.context = context;\n\t\t\t\t};\n\t\t\t\tr.addEventListener('_preact', this._listener);\n\t\t\t}\n\t\t}\n\t};\n\treturn h('slot', { ...props, ref });\n}\n\nfunction toVdom(element, nodeName) {\n\tif (element.nodeType === 3) return element.data;\n\tif (element.nodeType !== 1) return null;\n\tlet children = [],\n\t\tprops = {},\n\t\ti = 0,\n\t\ta = element.attributes,\n\t\tcn = element.childNodes;\n\tfor (i = a.length; i--; ) {\n\t\tif (a[i].name !== 'slot') {\n\t\t\tprops[a[i].name] = a[i].value;\n\t\t\tprops[toCamelCase(a[i].name)] = a[i].value;\n\t\t}\n\t}\n\n\tfor (i = cn.length; i--; ) {\n\t\tconst vnode = toVdom(cn[i], null);\n\t\t// Move slots correctly\n\t\tconst name = cn[i].slot;\n\t\tif (name) {\n\t\t\tprops[name] = h(Slot, { name }, vnode);\n\t\t} else {\n\t\t\tchildren[i] = vnode;\n\t\t}\n\t}\n\n\t// Only wrap the topmost node with a slot\n\tconst wrappedChildren = nodeName ? h(Slot, null, children) : children;\n\treturn h(nodeName || element.nodeName.toLowerCase(), props, wrappedChildren);\n}\n"],"names":["register","Component","tagName","propNames","options","PreactElement","inst","Reflect","construct","HTMLElement","_vdomComponent","_root","shadow","attachShadow","mode","prototype","Object","create","constructor","connectedCallback","attributeChangedCallback","disconnectedCallback","observedAttributes","keys","propTypes","forEach","name","defineProperty","get","this","_vdom","props","set","v","_props","type","setAttribute","customElements","define","displayName","ContextProvider","getChildContext","context","children","rest","_objectWithoutPropertiesLoose","_excluded","cloneElement","event","CustomEvent","detail","bubbles","cancelable","dispatchEvent","h","_extends","toVdom","hasAttribute","hydrate","render","toCamelCase","str","replace","_","c","toUpperCase","oldValue","newValue","undefined","Slot","ref","r","_listener","stopPropagation","addEventListener","removeEventListener","element","nodeName","nodeType","data","i","a","attributes","cn","childNodes","length","value","vnode","slot","wrappedChildren","toLowerCase"],"mappings":"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"}